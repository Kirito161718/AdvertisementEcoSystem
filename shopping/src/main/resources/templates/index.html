<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>商城首页</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .ad-space { background-color: #f8f9fa; min-height: calc(100vh - 56px); padding: 15px; border-left: 1px solid #dee2e6; border-right: 1px solid #dee2e6; }
        .ad-card { display: block; margin-bottom: 20px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; text-decoration: none; background: white; border: 1px solid #eee; }
        .ad-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .ad-img { width: 100%; height: auto; display: block; }
        .ad-title { padding: 8px; font-size: 12px; color: #666; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ad-badge-left { font-size: 10px; color: #dc3545; text-align: center; display: block; margin-bottom: 10px; font-weight: bold; }
        .ad-badge-right { font-size: 10px; color: #0d6efd; text-align: center; display: block; margin-bottom: 10px; font-weight: bold; }
        .product-img-container { height: 200px; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #fff; padding: 10px; }
        .product-img-top { max-height: 100%; max-width: 100%; object-fit: contain; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4 sticky-top">
    <!-- 修改点：首页链接 -->
    <a class="navbar-brand" th:href="@{/}"><i class="fas fa-store me-2"></i>我的商城</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <div class="text-white d-flex align-items-center">
            <span class="me-3">欢迎, <strong th:text="${user.username}"></strong></span>

            <span th:if="${user.role == 'USER'}" class="badge bg-info text-dark me-3" title="每3分钟更新一次">
                <i class="fas fa-heart me-1"></i>最感兴趣: <span th:text="${topInterest}"></span>
            </span>

            <!-- 修改点：链接增加 @{} -->
            <a th:if="${user.role == 'USER'}" th:href="@{/cart}" class="btn btn-outline-light btn-sm me-2">
                <i class="fas fa-shopping-cart"></i> 购物车
            </a>
            <a th:if="${user.role == 'ADMIN'}" th:href="@{/admin}" class="btn btn-warning btn-sm me-2">
                <i class="fas fa-cogs"></i> 管理后台
            </a>
            <a th:href="@{/logout}" class="btn btn-danger btn-sm">退出</a>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <!-- 左侧广告位 -->
        <div class="col-2 ad-space d-none d-md-block">
            <span class="ad-badge-left"><i class="fas fa-crosshairs me-1"></i>猜你喜欢</span>
            <div th:each="ad : ${leftAds}">
                <a th:href="${ad.targetUrl}" target="_blank" class="ad-card" title="精准推荐">
                    <img th:src="${ad.mediaUrl}" class="ad-img" alt="广告图片">
                    <div class="ad-title" th:text="${ad.title}">广告标题</div>
                </a>
            </div>
            <div th:if="${#lists.isEmpty(leftAds)}" class="text-center text-muted mt-5">
                <small>多看看商品<br>我们更懂你</small>
            </div>
        </div>

        <!-- 中间内容 -->
        <div class="col-md-8 col-12 p-4">
            <!-- 修改点：搜索表单 action -->
            <form th:action="@{/}" method="get" class="card p-3 mb-4 shadow-sm border-0 bg-white">
                <div class="row g-2">
                    <div class="col-md-2">
                        <select name="category" class="form-select form-select-sm">
                            <option value="">所有分类</option>
                            <option th:each="c : ${categories}" th:value="${c}" th:text="${c}"></option>
                        </select>
                    </div>
                    <div class="col-md-2"><input type="number" name="minPrice" class="form-control form-control-sm" placeholder="最低价"></div>
                    <div class="col-md-2"><input type="number" name="maxPrice" class="form-control form-control-sm" placeholder="最高价"></div>
                    <div class="col-md-2">
                        <select name="sort" class="form-select form-select-sm">
                            <option value="">默认排序</option>
                            <option value="asc">价格升序</option>
                            <option value="desc">价格降序</option>
                        </select>
                    </div>
                    <div class="col-md-3"><input type="text" name="search" class="form-control form-control-sm" placeholder="搜索商品..."></div>
                    <div class="col-md-1"><button type="submit" class="btn btn-primary btn-sm w-100"><i class="fas fa-search"></i></button></div>
                </div>
            </form>

            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
                <div class="col" th:each="p : ${products}">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="product-img-container">
                            <!-- 图片路径如果是相对路径，其实也应该处理，但这里假设存的是全路径或者 /uploads -->
                            <!-- 为了保险，如果是 /uploads 开头，最好也用 @{}，但复杂逻辑先不动，只动核心链接 -->
                            <img th:src="${p.imageUrl}" class="product-img-top" alt="商品图片">
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title text-truncate" th:text="${p.name}"></h6>
                            <div class="mb-2"><span class="badge bg-light text-secondary border" th:text="${p.category}"></span></div>
                            <h5 class="text-danger fw-bold mt-auto">¥ <span th:text="${p.price}"></span></h5>
                            <!-- 修改点：详情页链接 -->
                            <a th:href="@{/product/{id}(id=${p.id})}" class="btn btn-outline-primary btn-sm w-100 mt-2">查看详情</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧广告位 -->
        <div class="col-2 ad-space d-none d-md-block">
            <span class="ad-badge-right"><i class="fas fa-random me-1"></i>热门推荐</span>
            <div th:each="ad : ${rightAds}">
                <a th:href="${ad.targetUrl}" target="_blank" class="ad-card">
                    <img th:src="${ad.mediaUrl}" class="ad-img" alt="广告图片">
                    <div class="ad-title" th:text="${ad.title}">广告标题</div>
                </a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    setTimeout(function() {
        console.log("3分钟已到，刷新页面...");
        window.location.reload();
    }, 180000);
</script>
</body>
</html>